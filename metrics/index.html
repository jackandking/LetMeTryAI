<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metrics Dashboard - Event Data Distribution</title> <!-- Updated title -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Removed daterangepicker CSS -->
    <style>
        .metrics-section { margin-bottom: 2rem; }
        /* Removed unused styles */
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">Metrics Dashboard - Event Data Distribution</h1> <!-- Updated heading -->

        <!-- Event Data Distribution Section -->
        <div class="metrics-section">
            <h2>Event Data Distribution</h2>
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">Event Data Distribution by Event Type</h5>
                    <div class="table-responsive">
                        <table class="table table-striped" id="eventDataDistributionTable">
                            <thead>
                                <tr>
                                    <th>Event Type</th>
                                    <th>Event Data</th>
                                    <th>Count</th>
                                    <th>Percentage</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <!-- Removed chart canvas -->
                </div>
            </div>
        </div>

        <!-- Page Path by Event Type Section -->
        <div class="metrics-section">
            <h2>Page Path Distribution by Event Type (Ad Metrics)</h2>
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">Page Path Counts per Event Type</h5>
                    <div class="table-responsive">
                        <table class="table table-striped" id="pagePathByEventTypeTable">
                            <thead>
                                <tr>
                                    <th>Event Type</th>
                                    <th>Page Path</th>
                                    <th>Count</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Removed moment.js and daterangepicker JS -->
    <script type="module">
        import { queryDatabase } from '../util/mysql-util.js';
        window.queryDatabase = queryDatabase;

        // Import necessary components (none in this simplified version)
    </script>
    <script>
        // Removed date range picker JS

        // Placeholder for A/B tester IDs - replace with actual logic if needed
        const abTesterIds = ['tester_user_1', 'tester_user_abc']; // Example IDs

        // Load initial data
        function loadInitialData() {
            updateEventDataDistribution();
            updatePagePathByEventType(); // Add call to the new function
        }

        // Update event data distribution table
        function updateEventDataDistribution() {
            // Prepare the list of placeholders for the IN clause
            const placeholders = abTesterIds.map(() => '?').join(',');
            const query = `
                SELECT 
                    event_type,
                    event_data,
                    count,
                    percentage
                FROM (
                    SELECT 
                        event_type,
                        event_data,
                        COUNT(*) as count,
                        ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER (PARTITION BY event_type), 2) as percentage,
                        ROW_NUMBER() OVER (PARTITION BY event_type ORDER BY COUNT(*) DESC) as row_num
                    FROM event_metrics
                    ${abTesterIds.length > 0 ? `WHERE user_id NOT IN (${placeholders})` : ''}
                    GROUP BY event_type, event_data
                ) ranked
                WHERE row_num <= 10
                ORDER BY event_type, count DESC
            `;
            const params = abTesterIds.length > 0 ? [...abTesterIds] : [];

            queryDatabase(query, params, (error, results) => {
                if (error) {
                    console.error('Error fetching event data distribution:', error);
                    return;
                }

                const tbody = document.querySelector('#eventDataDistributionTable tbody');
                tbody.innerHTML = '';

                results.forEach(row => {
                    const tr = document.createElement('tr');
                    let eventDataContent = row.event_data;
                    // Basic check for image URL
                    if (typeof row.event_data === 'string' && (row.event_data.startsWith('http') || row.event_data.startsWith('https')) && (row.event_data.endsWith('.jpg') || row.event_data.endsWith('.png?') || row.event_data.endsWith('.png') || row.event_data.endsWith('.gif') || row.event_data.endsWith('.jpeg') || row.event_data.endsWith('.webp'))) {
                        // Display both the link and the image preview
                        eventDataContent = `<a href="${row.event_data}" target="_blank">${row.event_data}</a><br><img src="${row.event_data}" alt="Event Image" width="50">`;
                    }

                    tr.innerHTML = `
                        <td>${row.event_type}</td>
                        <td>${eventDataContent}</td>
                        <td>${row.count}</td>
                        <td>${row.percentage}%</td>
                    `;
                    tbody.appendChild(tr);
                });

                // Removed chart update logic
            });
        }

        // Call loadInitialData when the page loads
        document.addEventListener('DOMContentLoaded', loadInitialData);

        // Update Page Path by Event Type table
        function updatePagePathByEventType() {
            // Prepare the list of placeholders for the IN clause
            const placeholders = abTesterIds.map(() => '?').join(',');
            const query = `
                SELECT 
                    event_type,
                    page_path,
                    COUNT(*) as count
                FROM ad_metrics
                ${abTesterIds.length > 0 ? `WHERE user_id NOT IN (${placeholders})` : ''}
                GROUP BY event_type, page_path
                ORDER BY event_type, count DESC
            `;
            const params = abTesterIds.length > 0 ? [...abTesterIds] : [];

            queryDatabase(query, params, (error, results) => {
                if (error) {
                    console.error('Error fetching page path by event type data:', error);
                    return;
                }

                const tbody = document.querySelector('#pagePathByEventTypeTable tbody');
                tbody.innerHTML = ''; // Clear existing rows

                results.forEach(row => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${row.event_type}</td>
                        <td>${row.page_path}</td>
                        <td>${row.count}</td>
                    `;
                    tbody.appendChild(tr);
                });
            });
        }

        // Removed other functions (refreshAdMetrics, updateAdMetricsSummary, refreshEventMetrics, updateEventMetricsSummary, loadFilterOptions, updateAdTrendChart, updateEventTrendChart, updatePageLoadTimeChart, updateAdInsights, updateEventInsights, updatePageInsights)
    </script>
</body>
</html>