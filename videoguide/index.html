<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>5A景区视频导览</title>
    <script src="../util.js"></script>
    <script src="china5a.js"></script>
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .province-section {
            margin-bottom: 30px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .province-title {
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        .scenic-spot {
            margin: 15px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .spot-name {
            font-weight: bold;
            color: #2196F3;
            margin-bottom: 10px;
        }
        .video-list {
            margin-top: 10px;
        }
        .video-item {
            display: flex;
            flex-direction: column;
            margin: 10px 0;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 4px;
        }
        .video-url {
            word-break: break-all;
            margin-bottom: 10px;
            color: #2196F3;
            text-decoration: none;
        }
        .video-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .vote-count {
            margin: 0 10px;
            color: #666;
        }
        button {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background: #4CAF50;
            color: white;
        }
        button:hover {
            background: #45a049;
        }
        .add-video-form {
            margin-top: 10px;
        }
        input[type="text"] {
            padding: 5px;
            margin-right: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>5A景区视频导览</h1>
    <div id="provinces-container"></div>

    <script>
        // 初始化数据结构
        function initializeVideoGuides() {
            getConfig('videoguides', function(guides) {
                if (!guides) {
                    guides = {};
                    updateConfig('videoguides', guides);
                }
                displayProvinces(guides);
            });
        }

        // 显示省份和景点
        function displayProvinces(guides) {
            const container = document.getElementById('provinces-container');
            container.innerHTML = '';
            
            for (const province in china5a) {
                const provinceSection = document.createElement('div');
                provinceSection.className = 'province-section';
                
                const provinceTitle = document.createElement('h2');
                provinceTitle.className = 'province-title';
                provinceTitle.textContent = province;
                provinceSection.appendChild(provinceTitle);

                china5a[province].forEach(spot => {
                    const spotDiv = createSpotElement(spot, guides);
                    provinceSection.appendChild(spotDiv);
                });

                container.appendChild(provinceSection);
            }
        }

        // 创建景点元素
        function createSpotElement(spot, guides) {
            const spotDiv = document.createElement('div');
            spotDiv.className = 'scenic-spot';
            
            const spotName = document.createElement('div');
            spotName.className = 'spot-name';
            spotName.textContent = spot.name;
            spotDiv.appendChild(spotName);

            const videoList = document.createElement('div');
            videoList.className = 'video-list';
            
            // 显示现有视频
            const spotVideos = guides[spot.name] || [];
            spotVideos.forEach(video => {
                const videoItem = createVideoItem(video, spot.name);
                videoList.appendChild(videoItem);
            });

            // 添加新视频的表单
            const addForm = document.createElement('div');
            addForm.className = 'add-video-form';
            addForm.innerHTML = `
                <input type="text" placeholder="输入视频URL" />
                <button onclick="addVideo('${spot.name}')">添加视频</button>
            `;

            spotDiv.appendChild(videoList);
            spotDiv.appendChild(addForm);
            return spotDiv;
        }

        // 创建视频项目元素
        function createVideoItem(video, spotName) {
            const item = document.createElement('div');
            item.className = 'video-item';
            item.innerHTML = `
                <a class="video-url">${video.url}</a>
                <div class="video-actions">
                    <span class="vote-count">${video.votes || 0}票</span>
                    <button onclick="vote('${spotName}', '${video.url}')">投票</button>
                </div>
            `;
            return item;
        }

        // 添加新视频
        function addVideo(spotName) {
            const input = event.target.parentElement.querySelector('input');
            const url = input.value.trim();
            
            if (!url) {
                alert('请输入视频URL');
                return;
            }

            // 验证抖音视频URL格式
            const douyinPattern = /^https:\/\/v\.douyin\.com\/[\w-]+\/?$/;
            if (!douyinPattern.test(url)) {
                alert('请输入正确的抖音视频链接格式，例如：https://v.douyin.com/xxxxx/');
                return;
            }

            getConfig('videoguides', function(guides) {
                if (!guides[spotName]) {
                    guides[spotName] = [];
                }
                
                if (!guides[spotName].some(v => v.url === url)) {
                    guides[spotName].push({ url: url, votes: 0 });
                    updateConfig('videoguides', guides);
                    displayProvinces(guides);
                    input.value = '';
                } else {
                    alert('该视频已存在');
                }
            });
        }

        // 投票功能
        function vote(spotName, url) {
            getConfig('videoguides', function(guides) {
                const videos = guides[spotName];
                const video = videos.find(v => v.url === url);
                if (video) {
                    video.votes = (video.votes || 0) + 1;
                    updateConfig('videoguides', guides);
                    displayProvinces(guides);
                }
            });
        }

        // 初始化页面
        initializeVideoGuides();
    </script>
</body>
</html>